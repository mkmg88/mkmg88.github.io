<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>商店</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=1, minimum-scale=1.0, maximum-scale=1.0">
    <meta name="keywords" content="" />
    <meta name="description" content="" />
    <meta name="format-detection" content="telephone=no" />
    <link rel="stylesheet" href="release/css/shop.css">
</head>
<body>
    <div class="j-status u-loading" style="display: none;"> 
        <span>数据加载中...</span>
    </div>

    <section class="g-shophead">
        <div class="m-num">
            当前盒币数
            <strong id="j-hebiNum">0</strong>
        </div>
        <div class="m-inter">
            <a href="javascript:;" class="j-jumpToDianle">快速赚盒币&gt;</a>
            <p>100盒币=1游币/1Q币/1元话费</p>
        </div>
    </section>

    <section class="g-atrlist">
        <div class="m-shopTitle">
            <h3>热门物品</h3>
            <a href="javascript:;"></a>
        </div>
        <ul class="m-list" id="j-listCon">
        </ul>
    </section>

    <script type="text/template" id="j-offlineTemp">
            <span>你的网络走丢了~</span>
            <a href="javascript:;" class="j-reload">刷新试试</a>
    </script>

    <script type="text/template" id="j-shopListTemp">
        <li>
            <div class="warp">
                <a href="<%=link%>" class="shoplink">
                    <img class="u-icon" src="<%=logo%>" alt="<%=title%>">
                    <div class="f-center">
                        <h4 class="u-title"><%=title%></h4>
                        <p class="u-price">价格：<span><%=hebi%>盒币</span></p>
                        <p class="u-info"><%=num_used%>人已兑换</p>
                    </div>
                </a>
            </div>
            <a class="u-btn j-excDia" href="javascript:;" data-id="<%=key%>">兑换</a>
        </li>
    </script>

    <script type="text/template" id="j-shopDiaTemp">
            <div class="m-shopdiaCon j-shopdiaCon">
                <h4><span>兑换：</span><%=title%></h4>
                <div class="line"><p></p></div>
                <div class="u-xfinfo">
                    <p>消费盒币：<%=hebi%>个</p>
                    <%if(type == 3 && channel == 2) {%>
                    <p>充值手机号码：<%=phoneNum%></p>
                    <%}else if(channel == 4){%>
                    <p>收货电话：<%=addPhone%></p>
                    <p>收货地址：<%=address%></p>
                    <%}else if(type == 3 && channel == 3){%>
                    <p>兑换QQ号码：<%=qqNum%></p>
                    <%}else if(type == 3 ){%>
                    <p>充值账号：<%=nick%></p>
                    <%}%>
                </div>
                <p class="u-prompt">
                    <%if(type == 3 && channel == 1) {%>
                        <strong>温馨提示：</strong><br>
                        1、游币仅能充入当前的4399账号。<br>
                        2、游币在兑换成功后2个工作日内到账。<br>
                        3、兑换后可以在“查记录”中查看。
                    <%}else if(type == 3 && channel == 3){%>
                        <strong>温馨提示：</strong><br>
                        1、Q币仅能充入已设置的QQ账号。账号不可更改。<br>
                        2、Q币在兑换成功后3个工作日内到账。<br>
                        3、兑换后可以在“查记录”中查看。<br>
                        4、不同游戏盒不能设置同一个QQ号。
                    <%}else if( channel == 4){%>
                        <strong>温馨提示：</strong><br>
                        1. 小编将在2个工作日内向您寄出实物；<br>
                        2. 如需更改个人信息,请联系官方客服<br>QQ：1900004399.
                    <%}else if(type == 3 && channel == 2){%>
                        <strong>温馨提示：</strong><br>
                        1、话费仅能充入已设置的手机号码。账号不可更改。<br>
                        2、话费在兑换成功后2个工作日内到账。<br>
                        3、兑换后可以在“查记录”中查看。<br>
                        4、不同游戏盒不能设置同一个手机号。
                    <%}%>
                </p>
                <div class="u-btn clearfix">
                    <a class="btn-no j-cancel" href="javascript:;">取消</a>
                    <a class="btn-yes u-exchange j-exchange" href="javascript:;" data-id="<%=key%>">立即兑换</a>
                </div>
            </div>
    </script>
    <script type="text/template" id="j-errorTemp">
            <div class="m-errorDialog j-shopdiaCon">
                <p class="m-info"> 
                <%if(type == 0) {%>
                您的盒币不足，无法兑换，可以先去赚些盒币哦~ 
                <%}else if(type == 1){%>
                需要设置充值的QQ号，才可以充值哦~
                <%}else if(type == 2){%>
                需要设置充值的手机号，才可以充值哦~
                <%}%>
                </p>
                <div class="u-btn clearfix">
                    <a class="btn-no u-cancel j-cancelerror" href="javascript:;">稍后再说</a>
                    <%if(type == 0) {%>
                    <a class="btn-yes j-jumpToDianle" href="javascript:;">赚盒币</a>
                    <%}else if(type == 1){%>
                    <a class="btn-yes j-jumpToSgeQq" href="javascript:;">马上设置</a>
                    <%}else if(type == 2){%>
                    <a class="btn-yes j-jumpToSgePhone" href="javascript:;">马上设置</a>
                    <%}%>
                </div>
            </div>  
    </script>
    <script src="release/js/zepto.min.js"></script>
    <script src="release/js/baiduTemplate.js"></script>
    <script>

        var _config = {
            token: '',
            hebiNum: 100000,
            qqNum: '123',
            phoneNum: '123',
            nick: 'soricc',
            address: '厦门是望海路5号楼',
            addPhone: '177050843',
        }


        var shopCon = function(){
            var obj = this;
            var dom = {
                $listCon: $('#j-listCon'),
                $hebiNum: $('#j-hebiNum'),
                $status: $('.j-status')
            };
            
            var _url = {
                shopList:'json/shoplist.json',  /*商品列表*/
                hebiNum: 'json/hebinum.json',
                buy: ''  /*购买物品*/
            };

            this.listData = {};

            this.init = function(){
                if(localStorage && localStorage.listData){
                    var data = JSON.parse(localStorage.listData);
                    obj.parListData( data.result.list );
                }else {
                    dom.$status.show();
                };

                if(typeof navigator.onLine === 'boolean' && !navigator.onLine){
                    dom.$status.removeClass('u-loading').addClass('u-offline').html( $('#j-offlineTemp').html());
                };

                this.getList();
                this.events();
                this.getHebiNum();
            };

            this.events = function(){
                $(document).on('click','.j-jumpToDianle',function(){
                    ClientAPI.jumpToHomePage('indexDianle');
                });
                $(document).on('click','.j-excDia',function(){
                    obj.exchangeTip(this);
                });
                $(document).on('click','.j-exchange',function(){
                    obj.exchange(this);
                });
                $(document).on('click','.j-cancel',function(){
                    obj.closeDialog(1);
                });
                $(document).on('click','.j-cancelerror',function(){
                    obj.closeDialog();
                });
                /*去设置qq*/
                $(document).on('click','.j-jumpToSgeQq',function(){
                    ClientAPI.jumpToSetQqNum();
                });
                /*去设置电话*/
                $(document).on('click','.j-jumpToSgePhone',function(){
                    ClientAPI.jumpToSetPhoneNum();
                });
                /*刷新页面*/
                $(document).on('tap','.j-reload',function(){
                    window.location.reload();
                });
            };
            this.getData = function(url,data,callback){
                $.ajax({
                    type: "GET",
                    dataType: "json",
                    cache:false,
                    url: url,
                    data : data,
                    success:function(data){
                        callback(data);
                    }
                });
            };

            this.getHebiNum = function(){
                this.getData(_url.hebiNum,{},function(data){
                    if (data.code == 100) {
                        _config.hebiNum = data.result.num;
                        localStorage.hebiNum = data.result.num;
                        dom.$hebiNum.html(_config.hebiNum)
                    } else {
                        ClientAPI.toast(data.message);
                    }
                });
            };

            /*获取商品列表*/
            this.getList = function(){
                this.getData(_url.shopList,{},function(data){
                    if (data.code == 100) {
                        var stringData = JSON.stringify(data);
                        if(localStorage && localStorage.listData === stringData){
                            return;
                        }
                        localStorage.listData = stringData;
                        obj.parListData(data.result.list);
                        dom.$status.hide();
                    } else {
                        ClientAPI.toast(data.message);
                    }
                });
            };

            this.parListData = function(result){
                var html = [];
                for(var i=0; i<result.length; i++){
                    var _data = {
                        logo: result[i].logo,
                        hebi: result[i].hebi,
                        title: result[i].title,
                        price: result[i].price,
                        num_used: result[i].num_used,
                        key: result[i].key,
                        type: result[i].type,
                        link: result[i].summary_url,
                        channel: result[i].channel
                    };
                    obj.listData['key' + result[i].key] = _data;
                    html.push( baidu.template('j-shopListTemp',_data) );
                }
                dom.$listCon.append(html.join(''));
            };

            /*兑换提示*/
            this.exchangeTip = function(target){
                var key = $(target).attr('data-id');
                var thisData = obj.listData['key' + key];
                if(_config.phoneNum === '' && thisData.type == 3 && thisData.channel == 2){ /*未设置电话号码*/
                    obj.errorDiaolog(2);
                }else if(_config.qqNum === '' &&  thisData.type == 3 && thisData.channel == 3){ /*未设置qq号码*/
                    obj.errorDiaolog(1);
                }else if(thisData.hebi > _config.hebiNum){  /*盒币不够*/
                    obj.errorDiaolog(0);
                }else{
                    /*弹出兑换提示*/
                    var _data = {
                        title: thisData.title,
                        hebi: thisData.hebi,
                        nick: _config.nick,
                        qqNum: _config.qqNum,
                        phoneNum: _config.phoneNum,
                        key: thisData.key,
                        type: thisData.type,
                        channel: thisData.channel
                    };

                    var html = baidu.template('j-shopDiaTemp',_data);
                    obj.dialog(html);
                }
                return false;
            };

            this.dialog = function(html){
                if($(".j-dialog").length>0){
                    $(".j-dialog").remove();
                }
                var $result = $('<div class="g-shopDia j-dialog"></div>');
                $result.append(html).appendTo($('body'));
                var $con = $result.children('.j-shopdiaCon');
                var tipLeft = $con.width()/2;
                var tipTop = $con.height()/2;
                $con.css({
                    "marginLeft": -tipLeft,
                    "marginTop": -tipTop
                });
                $(document).on('touchmove.zz',function(e){
                e.preventDefault();
            })
            }
            this.closeDialog = function(){
                $('.j-shopdiaCon').parent().remove();
                 $(document).off('touchmove.zz')
                return false;
            };  

            /*错误提示框*/
            this.errorDiaolog = function(type){
                var html = baidu.template('j-errorTemp',{type: type});
                obj.dialog(html);
            };

            /*兑换*/
            this.exchange = function(target){
                var key = $(target).attr('data-id');
                this.getData(_url.buy,{id: key},function(data){
                    if (data.code == 100) {
                        ClientAPI.toast(data.message);
                        obj.closeDialog(1);
                        obj.getHebiNum();
                    } else {
                        ClientAPI.toast(data.message);
                    }
                });
            };
        };

        $(function(){
            var shopcon = new shopCon();
            shopcon.init();
        });
    </script>
</body>
</html>
