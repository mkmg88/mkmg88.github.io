<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8" />
    <title>记录</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=1, minimum-scale=1.0, maximum-scale=1.0">
    <meta name="keywords" content="" />
    <meta name="description" content="" />
    <meta name="format-detection" content="telephone=no" />
    <link rel="stylesheet" href="release/css/shop.css">
    <style>
    html,body {
      height: 100%;
      width: 100%;
      overflow-x: hidden;
    }
    </style>
</head>
<body>
    <script type="text/template" id="j-baseTemp">
        <ul class="f-tab <%if(!status) {%>toger<%}%> clearfix" id="j-tab">
            <li <%if(status) {%> class="active"<%}%> >盒币记录</li>
            <li <%if(!status) {%> class="active"<%}%> >兑换记录</li>
        </ul>

        <div class="f-tabview <%if(!status) {%>active<%}%>" id="j-tabview">
            <div class="tabview tabview1">
                <div class="tabview-scroll g-atrlist">
                    <div class="u-upload z-normal j-upload">下拉刷新哦~</div>
                    <ul class="m-list m-tablist" id="j-hebiBox"> </ul>
                    <p class="u-download j-load">数据加载中...</p>
                </div>
            </div>
            <div class="u-loading j-status">
                <span>数据加载中...</span>
            </div>
            <div class="tabview tabview2" >
                <div class="tabview-scroll g-atrlist g-loglist">
                    <div class="u-upload z-normal j-upload">下拉刷新哦~</div>
                    <ul class="m-list m-tablist" id="j-shopBox"> </ul>
                    <p class="u-download j-load" style="display: none;">数据加载中...</p>
                </div>
            </div>
            <div class="u-loading j-status">
                <span>数据加载中...</span>
            </div>
        </div>
    </script>

    <script type="text/template" id="j-hebiTemp">
        <li>
            <img class="u-icon" src="<%=logo%>" alt="<%=message%>">
            <div class="f-center">
                <h4 class="u-title"><%=message%></h4>
                <p class="u-info">完成时间：<%=time%></p>
            </div>
            <span class="u-status z-add"><%=num%>盒币</span>
        </li>
    </script>
    <script type="text/template" id="j-shopTemp">
        <li>
            <img class="u-icon" src="<%=logo%>" alt="<%=message%>">
            <div class="f-center">
                <h4 class="u-title"><%=message%></h4>
                <p class="u-info">兑换时间：<%=time%></p>
                <p class="u-info">支付盒币：<%=hebi%>个</p>
                <p class="u-info">消费编号：<%=order_id%></p>
                <%if(status == 2) {%>
                <p class="u-error">兑换异常，盒币已经返还至您的账号</p>
                <%}%>
            </div>
            <%if(status == 1) {%>
            <span class="u-status z-ed">已兑换</span>
            <%}else if(status == 0){%>
            <span class="u-status z-ing">兑换中</span>
            <%}else if(status == 2){%>
            <span class="u-status z-error">异常</span>
            <%}%>
        </li>
    </script>
    <script src="release/js/zepto.min.js"></script>
    <script src="release/js/iscroll-probe.min.js"></script>
    <script src="release/js/baiduTemplate.js"></script>
    <script>

    var Tab = function(){
        var obj =  this;

        var _dom = null;
        var urlPart = 'http://mobi.4399tech.com:8003/ios_app_cnd_test';
        var _url = {
            hebiLog: '/json/hebilog.json',
            shopLog: '/json/shoplog.json'
        };

        this.currentIndex = isStartTwo ? 1 : 0;
        this.startKey = ['',''];
        this.scroller = [];
        var isStartTwo = getUrlParam('type') === 'shop';

        function getUrlParam(name) {
            var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)");
            var r = window.location.search.substr(1).match(reg);
            if (r != null) return unescape(r[2]); return null;
        };

        this.init = function(){
            $('body').append( baidu.template('j-baseTemp',{status: !isStartTwo}) );
            _dom = {
                tab: $('#j-tab'),
                tabview: $('#j-tabview'),
                $hebiBox: $('#j-hebiBox'),
                $shopBox: $('#j-shopBox'),
                $hebiLoad: $('.j-load').eq(0),
                $shopLoad: $('.j-load').eq(1),
                $hebiStatus: $('.j-status').eq(0),
                $shopStatus: $('.j-status').eq(1),
                $hebiUpload: $('.j-upload').eq(0),
                $shopUpload: $('.j-upload').eq(1)
            }
            obj.upLoadHeight = _dom.$shopUpload.height();
            for(var i = 0; i < 2; i++){
                createTabScroll(i);
            }
            this.events();
            /*默认加载列*/
            if(!isStartTwo){
                this.loadMore(0,0);
            }else{
                this.loadMore(0,1);
            }
            if(typeof navigator.onLine === 'boolean' && !navigator.onLine){
                $('.j-status').removeClass('u-loading').addClass('u-offline').html('<span>你的网络走丢了~</span><a href="javascript:;" class="j-reload">刷新试试</a>');
                $(document).off('swipeRight swipeLeft');
            };
        };

        this.events = function(){
            $(document).on("click",'#j-tab li',function(){
                var index = $(this).index();
                tabToggle(index);
            });
            $(document).on('swipeRight','#j-tabview',function(){
                tabToggle(0);
            }).on('swipeLeft','#j-tabview',function(){
                tabToggle(1);
            });
            $(document).on('tap','.u-nodata,.j-reload',function(){
                var thatPage = obj.currentIndex == 0 ? 'hebi' : 'shop';
                window.location.search = '?type=' + thatPage;
            });

            $('.tabview-scroll').on('touchend',function(){
                if(obj.isUpLoad){
                    var thatPage = obj.currentIndex == 0 ? 'hebi' : 'shop';
                    _dom['$' + thatPage +'Upload'].removeClass('z-arrive').addClass('z-loading').text('加载中…');
                    obj.scroller[obj.currentIndex].scrollBy(0, -obj.upLoadHeight , 0);
                }
            });
        };

        function createTabScroll(i){
            obj.scroller[i] =  new IScroll($(".tabview")[i], {
                scrollX: false, 
                scrollY: true, 
                probeType: 3,
                scrollbars: true,
                deceleration: 0.01
            });
            obj.scroller[i].on('scroll',function(){
                var y = this.y;
                var height = i == 0 ?  _dom.$hebiBox.height() : _dom.$shopBox.height();

                if(y >= obj.upLoadHeight + 10 && !obj.isUpLoad){
                    obj.isUpLoad = true;
                    var thatPage = obj.currentIndex == 0 ? 'hebi' : 'shop';
                    _dom['$' + thatPage +'Upload'].removeClass('z-normal').addClass('z-arrive').text('松开看看~');
                }

                if(y - $(window).height() <=  -height - 30){
                    clearTimeout(obj.loadSet);
                    obj.loadSet = setTimeout(function(){
                        obj.loadMore(y,i);
                    },200);
                }
            });

            obj.scroller[i].on('scrollEnd',function(){
                if(obj.isUpLoad){
                    obj.isUpLoad = false;
                    var thatPage = obj.currentIndex == 0 ? 'hebi' : 'shop';
                    _dom['$' + thatPage + 'Load'].hide();
                    _dom['$' + thatPage + 'Status'].removeClass('u-nodata').addClass('u-loading').show();
                    obj.ajax(i,true);
                }
          
            });
        };
        function tabToggle(index){
            var className = 'active';
            _dom.tab.toggleClass('toger',!!index).find('li').removeClass(className).eq(index).addClass(className);
            _dom.tabview.toggleClass(className,!!index);
            obj.currentIndex = index;

            /*初次加载*/
            if(isStartTwo && obj.currentIndex == 0 && !obj.loadShopLog){
                obj.loadMore(0,0);
                obj.loadShopLog = true;
            }else if(!isStartTwo && obj.currentIndex == 1 && !obj.loadShopLog){
                obj.loadMore(0,1);
                obj.loadShopLog = true;
            }
        };


        /*滚动加载*/
        this.loadMore = function(y,index) {
            
            if (obj['noMore' + index] || obj.loadStatus) {
                return false;
            };
            obj.loadStatus = 1;

            clearTimeout(obj.ajaxLoadTimer);
            obj.ajaxLoadTimer = setTimeout(function(){
                obj.loadTimeout(index);
            },8000);

            obj.ajax(index);
        };


        this.loadTimeout = function(index){
            var thatPage = index == 0 ? 'hebi' : 'shop';
            if( _dom['$' + thatPage +'Box'].html().trim() === '' ){
                _dom['$' + thatPage +'Status'].removeClass('u-loading').addClass('u-nodata').html('<span>数据加载失败...点击刷新</span>');
            }else{
                _dom['$' + thatPage +'Load'].hide();
            }
            obj.timeOut = true;
        };

        this.ajax = function(index,upLoad){

            var url = _url.hebiLog;
            var curLoad = _dom.$hebiLoad;

            if(index == 1){
                url = _url.shopLog;
                curLoad = _dom.$shopLoad;
            };

            var startKey = !upLoad ? obj.startKey[index] : '';

            $.ajax({
                type: "GET",
                dataType: "json",
                url: url,
                timeout: 10000,
                data : {startKey : startKey},
                success:function(data){
                    if(data.code == 100){
                        var more = data.result.more;
                        var thatPage = obj.currentIndex == 0 ? 'hebi' : 'shop';

                        _dom['$' + thatPage +'Upload'].removeClass('z-loading').addClass('z-normal').text('下拉刷新哦~');

                        if(data.result.data && data.result.data.length > 0){
                            if (more == 0) {
                                obj['noMore' + index] = 1;
                                curLoad.hide();
                            }else{
                                curLoad.show();
                            }
                            if(index == 0){
                                obj.hebiRender(data.result.data,upLoad);
                                _dom.$hebiStatus.remove();
                            }else {
                                obj.shopRender(data.result.data,upLoad);
                                _dom.$shopStatus.remove();
                            }
                            obj.startKey[index] = data.result.startKey;
                        }else{
                            obj['noMore' + index] = 1;
                            curLoad.hide();
                            if(index == 0){
                                obj.hebiRender(data.result.data);
                                _dom.$hebiStatus.removeClass('u-loading').addClass('u-nodata').html('<span>没有数据，点击刷新</span>');
                            }else {
                                obj.shopRender(data.result.data);
                                _dom.$shopStatus.removeClass('u-loading').addClass('u-nodata').html('<span>没有数据，点击刷新</span>');
                            };
                        };
                        
                        obj.loadStatus = 0;
                    }else{
                        ClientAPI.toast(data.message);
                    }
                    clearTimeout(obj.ajaxLoadTimer);
                },
                error: function(a, b, c) {
                    if (b == "timeout" || b == "abort") {
                        ClientAPI.toast("请检查您的网络");
                    }
                    clearTimeout(obj.ajaxLoadTimer);
                }
            });
        };

        this.hebiRender = function(result,upLoad){
            var html = [];
            for(var i=0; i<result.length; i++){
                var _data = {
                    logo: result[i].logo,
                    message: result[i].message,
                    time: result[i].time,
                    num: result[i].num
                };
                html.push( baidu.template('j-hebiTemp',_data) );
            }
            if(!upLoad){
                _dom.$hebiBox.append(html.join(''));
            }else{
                _dom.$hebiBox.html(html.join(''));
            }
            obj.scroller[0].refresh();
        };
   
        this.shopRender = function(result,upLoad){
            var html = [];
            for(var i=0; i<result.length; i++){
                var _data = {
                    logo: result[i].logo,
                    message: result[i].message,
                    time: result[i].time,
                    hebi: result[i].hebi,
                    order_id: result[i].order_id,
                    status: result[i].status
                };
                html.push( baidu.template('j-shopTemp',_data) );
            }
            
            if(!upLoad){
                _dom.$shopBox.append(html.join(''));
            }else{
                _dom.$shopBox.html(html.join(''));
            }
            obj.scroller[1].refresh();
        };
    };


    $(function(){
        (new Tab).init();
    });

    document.addEventListener('touchmove', function(e){ 
        e.preventDefault(); 
    }, false);
    </script>
</body>
</html>
