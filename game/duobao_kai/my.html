<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8" />
    <title>盒子三周年庆 - 与你相约看现场直播</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=1, minimum-scale=1.0, maximum-scale=1.0">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="keywords" content="" />
    <meta name="description" content="" />
    <link href="release/css/style.css" type="text/css" rel="stylesheet" />
</head>
<body>

<section class="g-myhead">
    <div class="m-warp" id="j-userinfo">
        <!-- i-lv4 -->
    </div>
</section>

<section class="g-mytab">
    <ul class="m-tabtop clearfix" id="j-tabtop">
        <li class="i-active">我的资产</li>
        <li>夺宝记录</li>
    </ul>
    <div class="m-tabbox" id="j-tabbot">
        <!-- tab1 -->
        <div>
            <ul class="m-assets">
                <li>
                    <p>我的盒币<span id="j-myhebi">0盒币</span></p>
                    <a href="javascript:;">充值</a>
                </li>
                <li>
                    <p>我的夺宝券<span id="j-myticket">0张</span></p>
                    <a href="javascript:;">如何获得</a>
                </li>
            </ul>
        </div>
        
        <!-- tab2 -->
        <div style="display: none;">
            <ul class="m-log m-listul" id="j-logwarp">
            </ul>
            <p class="m-loadmore" id="j-loadtip">正在努力加载...</p>
        </div>
    </div>
    
</section>

<section class="g-recommend clearfix" id="j-starttop">
    <div class="m-recbox">
        <h3 class="i-new">最新上架</h3>
        <ul class="m-listul" id="j-newestWarp"></ul>
    </div>
    <div class="m-recbox">
        <h3 class="i-hot">马上抢完</h3>
        <ul class="m-listul" id="j-endingWarp"></ul>
    </div>
</section>

<section class="g-predb">
    <div class="m-follow">
        <a href="javascript:;" class="avast"><img src="lib/avast.png" alt=""></a>
        <p>关注“我是小然”小编号，留言互动夺宝问题、提出玩法建议、说出夺宝心愿，给大家带来最好的夺宝体验。</p>
        <a href="javascript:;" class="btn">关注</a>
    </div>
</section>

<footer class="g-footer">
    本活动最终解释权归4399官方所有<br>
    &copy;2004-2016四三九九网络股份有限公司
</footer>

<script type="text/template" id="j-userTemp">
    <a href="javascript:;" class="m-avast" ><img src="<%=face%>" alt="<%=nick%>"></a>
    <p class="m-nick"><%=nick%></p>
    <a class="m-medal" href="javascript:;"><%if(madel) {%><img src="<%=madel%>" alt=""><%}%></a>
</script> 

<script type="text/template" id="j-logTemp">
    <%for(var i=0;i<list.length;i++){%>
    <li>
        <a href="javascript:;" class="clearfix" data-id="<%=list[i].id%>">
            <img class="pic" src="<%=list[i].cover%>" alt="">
            <dl>
                <dt><%=list[i].title%></dt>
                <dd class="info"> 
                    <p>第<%=list[i].goods_phase%>期</p>
                    <p>获奖号码：<%if(list[i].lucky_num) {%><span><%=list[i].lucky_num%></span><%}%></p>
                    <p>获奖者：<%if(list[i].lucky_nick) {%><span><%=list[i].lucky_nick%></span><%}%></p>
                </dd>
            </dl>
            <%if(list[i].status == 1) {%>
                <span class="btn i-ing">正在进行</span>
            <%}else if(list[i].status == 2) {%>
                <span class="btn i-make">正在揭晓</span>
            <%}else if(list[i].status == 3) {%>
                <!--中奖-->
                <%if(list[i].is_lucky == 1) {%>
                    <%if(list[i].has_got == 1) {%>
                        <span class="btn i-get">立即晒图</span>
                    <%}else if(list[i].has_got == 0) {%>
                        <%if(list[i].has_out == 1) {%>
                            <span class="btn i-end">领取超时</span>
                        <%}else if(list[i].has_got == 0) {%>
                            <span class="btn i-draw">立即领取</span>
                        <%}%>
                    <%}%>
                <!--未中奖-->
                <%}else if(list[i].status == 0) {%>
                    <span class="btn i-fail">夺宝失败</span> 
                <%}%> 
            <%}%>
        </a>
    </li>
    <%}%>
</script>

<script type="text/template" id="j-moreTemp">
    <%for(var i=0;i<list.length;i++){%>
    <li>
        <a href="javascript:;" class="clearfix" data-id="<%=list[i].id%>">
            <img class="pic" src="<%=list[i].cover%>" alt="">
            <dl>
                <dt><%=list[i].title%></dt>
                <dd class="info">还剩<span><%=(list[i].max_num - list[i].now_num)%></span>人次</dd>
            </dl>
        </a>
    </li>
    <%}%>
</script>

<!-- 弹窗 -->
<script type="text/template" id="j-ds3">
    <div class="m-diacon m-mydig">
        <h5>夺宝券说明</h5>
        <dl>
            <dt>1、夺宝券是什么？</dt>
            <dd>夺宝券为5盒币夺宝活动专属道具，可用来抵消参与本活动消耗的盒币，每张面值5盒币。</dd>
            <dt>2、夺宝券怎么用？</dt>
            <dd>夺宝券不能单独使用，只能在使用盒币夺宝时一起使用。</dd>
            <dt>3、夺宝券如何获得？</dt>
            <dd>1）当天每消耗100盒币，奖励1张夺宝券；</dd>
            <dd>2）每天第一次参加夺宝活动后分享动态，可获得2盒币购买1张夺宝券的机会；</dd>
            <dd>3）平时不可直接购买，不定时的夺宝券促销或奖励活动会放出。</dd>
        </dl>
        
        <div class="m-btnone">
            <a href="javascript:;" class="m-draw j-close">知道了</a>
        </div>
    </div>
</script>


<!-- 弹窗 -->
<script type="text/template" id="j-ds2">
    <div class="m-diacon m-mydig">
        <h5>当前您参与夺宝活动<br>已消耗666盒币</h5>
        <dl class="fz">
            <dt>参与夺宝消耗盒币可解锁对应的等级勋章</dt>
            <dd>夺宝新兵：0-2000<br>     
            夺宝士兵：2001-5000<br>
            夺宝达人：5001-10000<br>
            ……<br>
            更多等级即将开放。</dd>
        </dl>
        
        <div class="m-btnone">
            <a href="javascript:;" class="m-draw j-close">知道了</a>
        </div>
    </div>
</script>

<script src="release/js/zepto.min.js"></script>
<script src="release/js/baiduTemplate.js"></script>
<script>
     var Indiana = function(){
         var obj = this;

         var _url = {
             mineAjax: 'json/mineAjax.json',
             myBuyLog: 'json/myBuyLog.json'
         };

         var _dom = {
            tabTop: $('#j-tabtop > li'),
            tabBot: $('#j-tabbot > div'),
            userinfo: $('#j-userinfo'),
            myHebi: $('#j-myhebi'),
            myTicket: $('#j-myticket'),
            logWarp: $('#j-logwarp'),
            loadTip: $('#j-loadtip'),
            startTop: $("#j-starttop"),
            newestWarp: $('#j-newestWarp'),
            endingWarp: $('#j-endingWarp')
        };

        var _config = {
            scookie: '',
            page: 1
        };

         this.init = function(){
            this.getMineAjax();
            this.bindEvent();

            /*obj.dialog( $('#j-ds2').html() );*/
         };

         this.bindEvent = function(){
            _dom.tabTop.on('click',function(){
                obj.tabTarger( $(this), _dom.tabBot, 'i-active');
            });
            /*滚动加载*/
            $(window).on('scroll',function(){
                if( obj.currTab == 1 ){
                    clearTimeout(obj.loadSet);
                    obj.loadSet = setTimeout(function(){
                        obj.loadMore();
                    },200);
                };
            });
         };

         /*tab切换*/
         this.tabTarger = function(topLi,botLi,className){
            var currIndex = topLi.index();
            topLi.addClass(className).siblings().removeClass(className);
            botLi.eq( currIndex ).show().siblings().hide();
            obj.currTab = currIndex;
            if(!obj.fisrtLaod && currIndex == 1){
                obj.getMyBuyLog();
            }
         };

         /*获取用户信息*/
         this.getMineAjax = function(){
             $.getJSON(_url.mineAjax,{ scookie: _config.scookie },function(data){
                if(data.code == 100){
                    obj.parUserInfo(data.result);
                    obj.parMoreList(data.result);
                }else{
                    alert(data.message);
                };
             });
         };

         /*处理用户信息*/
         this.parUserInfo = function(res){
            _dom.userinfo.html( baidu.template('j-userTemp',res) );
            _dom.myHebi.html( res.my_hebi + '盒币' );
            _dom.myTicket.html( res.my_ticket + '张' );
         };

         /*最新上架和马上抢完*/
         this.parMoreList = function(res){
            _dom.newestWarp.html( baidu.template('j-moreTemp',{list: res.newest_list }) );
            _dom.endingWarp.html( baidu.template('j-moreTemp',{list: res.ending_list }) );
         };

        /*获取夺宝记录*/
        this.getMyBuyLog = function(){
             $.getJSON(_url.myBuyLog,{ scookie: _config.scookie, page: _config.page },function(data){
                if(data.code == 100){
                    if (data.result.pagecount <= _config.page) {
                        obj.noMore1 = 1;
                        _dom.loadTip.text("没有了");
                    }else{
                        _dom.loadTip.text("滑动加载");
                    };
                    obj.parBuyLog(data.result);
                    _config.page ++;
                }else{
                    alert(data.message);
                };
                obj.loadStatus = 0;
             });
        };

        this.parBuyLog = function(res){
            _dom.logWarp.append( baidu.template('j-logTemp',{list: res.data}) );
        };

        /*滚动加载*/
        this.loadMore = function() {
             if (this.noMore1 || obj.loadStatus) {
                 return false;
             };
             if ((+$(window).scrollTop() + $(window).height()) >= _dom.startTop.offset().top) {
                 obj.loadStatus = 1;
                 _dom.loadTip.text("正在努力加载..");
                 this.getMyBuyLog();
             };
        };

        this.dialog = function(html){
            if($(".j-dialog").length>0){
                $(".j-dialog").remove();
            }
            var $result = $('<div class="g-shopDia j-dialog"></div>');
            $result.append(html).appendTo($('body'));
            var $con = $result.children('.m-diacon');
            var tipLeft = $con.width()/2;
            var tipTop = $con.height()/2;
            $con.css({
                "marginLeft": -tipLeft,
                "marginTop": -tipTop
            });
            $(document).on('touchmove.zz',function(e){
                e.preventDefault();
            });
        };

        this.closeDialog = function(){
            $('.j-dialog').remove();
            $(document).off('touchmove.zz')
            return false;
        };
     };

    $(function(){
         new Indiana().init();
    });
</script>
</body>
</html>
