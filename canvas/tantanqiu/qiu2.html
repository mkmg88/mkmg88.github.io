<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>qiuqiu</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=1, minimum-scale=1.0, maximum-scale=1.0">
    <link rel="stylesheet" href="css/style.css">
</head>

<body>


    <div class="g-gamebox" id="j-gamebox">
        <canvas id="canvas"></canvas>

        <div class="m-spcc">
            <span id="j-spcc" style="width:0%;"></span>
        </div>

        <a class="m-btn" href="javascript:;" id="j-btn">长按蓄力</a>
    </div>

    <script src="js/zepto.min.js"></script>
    <script>

    function Spring(){
        var obj = this;
        var app;

        var gamebox = $('#j-gamebox');
        var canvas = document.getElementById('canvas');
        var context = canvas.getContext('2d');

        canvas.width = gamebox.width();
        canvas.height = gamebox.height();

        var launchWidth = canvas.width*0.15;

        /*spriing*/
        var spring = {
            left: canvas.width * 0.85,
            width: canvas.width * 0.13,
            height: canvas.height * 0.29
        };
        spring.top = canvas.height - spring.height - 2;
        var springImg = new Image();

        var spcc = $('#j-spcc');
        var spccWidth = 0;
        var spccTimer = false;
        var spccAdd = true;

        this.init = function(){
            springImg.src = 'http://f1.img4399.com/ma~241_20161222141938_585b707a63775.png?t=1482387578';
            springImg.onload = function(){
                app = new Draw();
            };
            this.bindEvent();
        };

        this.ready = function(current,callback){
            this.current = current;
            this.callback = callback;
        };

        this.bindEvent = function(){
            $('#j-btn').on('touchstart',function(){
                spccWidth = 0;
                app.parData = false;
                ball.x = spring.left + spring.width/2;
                ball.y = spring.top - ball.r + 2;
                app.drawApp();
                spccTimer = setTimeout(function fn(){
                    if( spccAdd && spccWidth >= 100 ){
                        spccAdd = false;
                    }else if(!spccAdd && spccWidth <= 0){
                        spccAdd = true;
                    };
                    if(spccAdd){
                        spccWidth ++;
                    }else{
                        spccWidth --;
                    };
                    var height = spring.height - (spring.height * spccWidth/200);
                    app.drawSpring( spring.height - (spring.height * spccWidth/200) );
                    app.drawBall( ball.x, canvas.height - height - ball.r + 2 ,ball.r,'#17d6e2' );
                    spcc.width(spccWidth + '%');
                    spccTimer = setTimeout(fn,13);
                },13);
                return false;
            });

            $('#j-btn').on('touchend',function(){
                clearTimeout(spccTimer);
                app.drawSpring( spring.height );
                app.drawBall( ball.x,ball.y,ball.r,'#17d6e2' );
                app.move();

                ball.speedX = -5 - 10 * spccWidth/100;
                ball.speedY = -50 - 50 * spccWidth/200;
            });
        };



        /*障碍小球*/
        var obs = {
            r: 4,
            mass: 10,
            balls: [
                [0,1,0,1,0,1,0,1,0,1,0,1,0,1,0],
                [1,0,1,0,1,0,1,0,1,0,1,0,1,0,1],
                [0,1,0,1,0,1,0,1,0,1,0,1,0,1,0],
                [1,0,1,0,1,0,1,0,1,0,1,0,1,0,1]
            ],
            pos: []
        };

        /*底部栏*/
        var btObs = {
            length: 6,
            y: canvas.height - canvas.height * 0.23,
            pos: []
        };
        btObs.width = (canvas.width - launchWidth - 10)/btObs.length;
        for(var i=0; i<btObs.length; i++){
            btObs.pos.push({
                x: btObs.width* i,
                x2: btObs.width* (i+1)
            });
        };

        obs.intervalx = (canvas.width - launchWidth)/(obs.balls[0].length + 1);
        obs.offt = canvas.height * 0.26;
        obs.intervaly = canvas.height * 0.14;


        var ball = {
            speed: 1,
            r: canvas.width*0.03,
            mass: 20
        };
        ball.x = spring.left + spring.width/2;
        ball.y = spring.top - ball.r + 2;

        var first = 0;
        var xzz,yzz;

        this.init();

        function Draw(){
            this.init();
        }
        Draw.prototype = {
            init: function(){
                var _this = this;
                this.drawApp(ball.x,ball.y);
                first = 1;
            },

            /*绘制障碍*/
            drawObs: function(){
                var _this = this,x,y;
                obs.balls.forEach(function(oys,yIndex){
                    oys.forEach(function(ox,xIndex){
                        if(ox){
                            x = obs.intervalx * (xIndex + 1);
                            y = obs.offt + obs.intervaly * yIndex;
                            _this.drawBall(x , y,obs.r,'#688db7');
                            !first && obs.pos.push({x:x, y:y});
                        }
                    });
                });
            },
            /*绘制球*/
            drawBall: function(x,y,r,color){
                context.beginPath();
                context.fillStyle = color || '#333';
                context.arc(x,y,r,0,2*Math.PI);
                context.fill();
                context.closePath();
            },

            drawLine: function(){
                for(var i=0; i<btObs.pos.length; i++){
                    context.beginPath();
                    context.fillStyle = 'green';
                    context.rect(btObs.pos[i].x2,btObs.y, 2, canvas.height - btObs.y);
                    context.fill();
                    context.closePath();
                }
            },

            drawSpring: function(height){
                context.beginPath();
                if(height){
                    context.clearRect(spring.left,0 ,spring.width, canvas.height);
                }
                height = height || spring.height;
                var top = canvas.height - height;
                context.drawImage(springImg,spring.left,top,spring.width,height);
                context.closePath();
            },

            /*绘制整个画布*/
            drawApp: function(){
                context.clearRect(0,0,canvas.width,canvas.height);
                this.drawObs();
                //this.drawLine();
                this.drawSpring();
                this.drawBall(ball.x,ball.y,ball.r,'#17d6e2');
            },

            /*根据角度计算X轴和Y轴每次要移动的量*/
            updataBall: function(){
                var radians = ball.radio*Math.PI/180;
                xzz = Math.cos(radians)*ball.speed;
                yzz = Math.sin(radians)*ball.speed;
            },

            move: function(){
                var _this = this;
                var timerId = null;
                /*move*/
                function fn(){
                    _this.collide();

                    ball.speedY =  ball.speedY + 3;
                    ball.x = ball.x + ball.speedX;
                    ball.y = ball.y + ball.speedY;

                    _this.collideBt();

                    if(_this.parData){
                        /*x边界*/
                        if(ball.x + ball.r > canvas.width - launchWidth ){
                            ball.speedX *= -0.55;
                            ball.speedY *= 0.55;
                            ball.x = canvas.width - ball.r - launchWidth;
                        }else if(ball.x - ball.r < 0){
                            ball.speedX *= -0.55;
                            ball.speedY *= 0.55;
                            ball.x = 0 + ball.r;
                        }
                    }else if(ball.x + ball.r > canvas.width){
                        ball.speedX *= -0.55;
                        ball.speedY *= 0.55;
                        ball.x = canvas.width - ball.r;
                    }

                    /*y边界*/
                    if( ball.y + ball.r > canvas.height ){
                        ball.speedY *= -0.55;
                        ball.speedX *= 0.55;
                        ball.y = canvas.height - ball.r;
                    }else if(ball.y - ball.r < 0){
                        ball.speedY *= -0.55;
                        ball.speedX *= 0.55;
                        ball.y = ball.r;
                        /*if(!_this.parData){
                            var pos = {
                                371: [{x:-65,y:0},{x:-50,y:-5},{x:-46,y:0},{x:-30,y:3},{x:-40,y:-3},{x:-10,y:0}],
                                336: [{x:-75,y:0},{x:-50,y:-5},{x:-52,y:5},{x:-36,y:3},{x:-16,y:0},{x:-8,y:0}],
                                323: [{x:-55,y:0},{x:-40,y:0},{x:-26,y:-2},{x:-20,y:0},{x:-20,y:-2},{x:-6,y:0}],
                                287: [{x:-55,y:0},{x:-45,y:-5},{x:-36,y:3},{x:-36,y:0},{x:-16,y:0},{x:-16,y:3}]
                            };

                            var current = obj.current;
                            var thisPos = pos[canvas.width];

                            ball.x = canvas.width - launchWidth - ball.r;
                            ball.y = 0;
                            ball.speedX = thisPos[current].x;
                            ball.speedY = thisPos[current].y;

                            console.log(current,thisPos[current].x,thisPos[current].y);
                            _this.parData = true;
                        }*/
                    };

                    if(Math.abs(ball.speedX)<1.5) ball.speedX=0;
                    if(Math.abs(ball.speedY)<1.5) ball.speedY=0;

                    if(ball.speedX == 0 && ball.speedY == 0 && ball.y + ball.r >= canvas.height){
                        obj.callback && obj.callback();
                        ball.y = canvas.height - ball.r;
                        return;
                    }else{
                       _this.drawApp();
                    };
                    if(window.requestAnimationFrame){
                        timerId = requestAnimationFrame(fn);
                    }else{
                        setTimeout(fn,13);
                    };
                }


                if(window.requestAnimationFrame){
                    timerId = requestAnimationFrame(fn);
                }else{
                    setTimeout(fn,13);
                };
            },
            /*判断两球是否碰撞*/
            hitTestCircle: function(obsBall){
                var retval = false;
                var dx = ball.x - obsBall.x;
                var dy = ball.y - obsBall.y;
                var distance = dx*dx + dy*dy;
                if(distance <= (ball.r + obs.r) * (ball.r + obs.r) ){
                    retval = true;
                }
                return retval;
            },

            /*循环遍历每个碰撞点*/
            collide: function(){
                for(var i=0; i<obs.pos.length; i++){
                    if(this.hitTestCircle(obs.pos[i])){
                        this.collideBalls(obs.pos[i]);
                        //debugger;
                        break;
                    }
                }
            },

            collideBalls: function(obsBall){
                var dx = ball.x - obsBall.x;
                var dy = ball.y - obsBall.y;
                var R = ball.r + obs.r;

                var lv = Math.sqrt(dx*dx + dy+dy);
                var collisionAngle = Math.atan2(dy,dx);

                if( lv < R ){
                    ball.x = Math.ceil(ball.x + Math.cos(collisionAngle) * ( R - lv ));
                    ball.y = Math.ceil(ball.y + Math.sin(collisionAngle) * ( R - lv ));
                    this.drawApp();
                }
                ball.speedX *= -1;
            },

            hitTextCircleBt: function(obsLine){
                var retval = false;

                var x1 = obsLine.x + 5;
                var x2 = obsLine.x + btObs.width;
                var y = btObs.y;

                if( ball.y + ball.r > y ){
                    if( ball.x - ball.r < x1 &&  ball.x + ball.r > x1 ){
                        ball.x = x1 + ball.r + 3;
                        retval = true;
                    }else if(ball.x + ball.r > x2 && ball.x - ball.r  < x2){
                        ball.x = x2 - ball.r - 3;
                        retval = true;
                    }
                }
                return retval;
            },

            collideBt: function(){
                for(var i=0; i<btObs.pos.length; i++){
                    if(this.hitTextCircleBt(btObs.pos[i]) ){
                        ball.speedX *= -0.9;
                        break;
                    }
                }
            }
        }

    }

    var spring = new Spring();

    spring.ready(4);








    </script>
</body>

</html>
